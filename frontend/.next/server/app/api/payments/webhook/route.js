"use strict";(()=>{var e={};e.id=4,e.ids=[4],e.modules={30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},6113:e=>{e.exports=require("crypto")},84884:(e,t,r)=>{r.r(t),r.d(t,{headerHooks:()=>h,originalPathname:()=>P,requestAsyncStorage:()=>w,routeModule:()=>b,serverHooks:()=>O,staticGenerationAsyncStorage:()=>_,staticGenerationBailout:()=>f});var n={};r.r(n),r.d(n,{POST:()=>c}),r(65629);var o=r(70532),a=r(84952),i=r(29622),s=r(6113),u=r.n(s);async function c(e){try{let t=await e.text(),r=e.headers.get("x-signature"),n=process.env.LEMON_SQUEEZY_WEBHOOK_SECRET;if(!n)return console.error("LEMON_SQUEEZY_WEBHOOK_SECRET not configured"),i.Z.json({error:"Webhook secret not configured"},{status:500});let o=u().createHmac("sha256",n);o.update(t);let a=o.digest("hex");if(r!==a)return console.error("Invalid webhook signature"),i.Z.json({error:"Invalid signature"},{status:401});let s=JSON.parse(t);switch(s.meta.event_name){case"order_created":await d(s);break;case"subscription_created":await p(s);break;case"subscription_updated":await l(s);break;case"subscription_cancelled":await E(s);break;default:console.log(`Unhandled webhook event: ${s.meta.event_name}`)}return i.Z.json({received:!0})}catch(e){return console.error("Webhook error:",e),i.Z.json({error:"Webhook processing failed"},{status:500})}}async function d(e){let{data:t}=e,r=t.attributes.first_order_item.product_options.custom;if(!r?.user_id||!r?.plan_id){console.error("Missing custom data in order");return}let n=r.user_id,o=r.plan_id,a=Object(function(){var e=Error("Cannot find module '@/lib/pricing-plans'");throw e.code="MODULE_NOT_FOUND",e}())(o);if(!a){console.error(`Plan not found: ${o}`);return}await Object(function(){var e=Error("Cannot find module '@/lib/prisma'");throw e.code="MODULE_NOT_FOUND",e}()).subscription.upsert({where:{userId:n},update:{planType:"month"===a.interval?"MONTHLY":"LIFETIME",status:"ACTIVE",priceAmount:100*a.price,currency:a.currency,lemonSqueezyId:t.id,currentPeriodStart:new Date,currentPeriodEnd:new Date("month"===a.interval?Date.now()+2592e6:Date.now()+31536e8)},create:{userId:n,planType:"month"===a.interval?"MONTHLY":"LIFETIME",status:"ACTIVE",priceAmount:100*a.price,currency:a.currency,lemonSqueezyId:t.id,currentPeriodStart:new Date,currentPeriodEnd:new Date("month"===a.interval?Date.now()+2592e6:Date.now()+31536e8)}}),console.log(`Subscription created/updated for user ${n} with plan ${o}`)}async function p(e){await d(e)}async function l(e){let{data:t}=e,r=t.id;await Object(function(){var e=Error("Cannot find module '@/lib/prisma'");throw e.code="MODULE_NOT_FOUND",e}()).subscription.updateMany({where:{lemonSqueezyId:r},data:{status:"active"===t.attributes.status?"ACTIVE":"CANCELED",currentPeriodEnd:new Date(t.attributes.renews_at)}}),console.log(`Subscription updated: ${r}`)}async function E(e){let{data:t}=e,r=t.id;await Object(function(){var e=Error("Cannot find module '@/lib/prisma'");throw e.code="MODULE_NOT_FOUND",e}()).subscription.updateMany({where:{lemonSqueezyId:r},data:{status:"CANCELED",cancelAtPeriodEnd:!0}}),console.log(`Subscription cancelled: ${r}`)}(function(){var e=Error("Cannot find module '@/lib/prisma'");throw e.code="MODULE_NOT_FOUND",e})(),function(){var e=Error("Cannot find module '@/lib/pricing-plans'");throw e.code="MODULE_NOT_FOUND",e}();let m=o.AppRouteRouteModule,b=new m({definition:{kind:a.x.APP_ROUTE,page:"/api/payments/webhook/route",pathname:"/api/payments/webhook",filename:"route",bundlePath:"app/api/payments/webhook/route"},resolvedPagePath:"/home/project/frontend/app/api/payments/webhook/route.ts",nextConfigOutput:"",userland:n}),{requestAsyncStorage:w,staticGenerationAsyncStorage:_,serverHooks:O,headerHooks:h,staticGenerationBailout:f}=b,P="/api/payments/webhook/route"},84952:(e,t)=>{var r;Object.defineProperty(t,"x",{enumerable:!0,get:function(){return r}}),function(e){e.PAGES="PAGES",e.PAGES_API="PAGES_API",e.APP_PAGE="APP_PAGE",e.APP_ROUTE="APP_ROUTE"}(r||(r={}))}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),n=t.X(0,[670],()=>r(84884));module.exports=n})();