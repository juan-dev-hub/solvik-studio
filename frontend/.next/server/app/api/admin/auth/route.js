"use strict";(()=>{var e={};e.id=266,e.ids=[266],e.modules={30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},20082:(e,r,t)=>{t.r(r),t.d(r,{headerHooks:()=>O,originalPathname:()=>w,requestAsyncStorage:()=>c,routeModule:()=>l,serverHooks:()=>m,staticGenerationAsyncStorage:()=>f,staticGenerationBailout:()=>h});var n={};t.r(n),t.d(n,{POST:()=>u}),t(65629);var o=t(70532),a=t(84952),i=t(29622),s=t(62704);(function(){var e=Error("Cannot find module '@/lib/prisma'");throw e.code="MODULE_NOT_FOUND",e})(),function(){var e=Error("Cannot find module '@/lib/otp-service'");throw e.code="MODULE_NOT_FOUND",e}(),function(){var e=Error("Cannot find module '@/lib/encryption'");throw e.code="MODULE_NOT_FOUND",e}();let d=s.z.object({step:s.z.enum(["whatsapp","email","verify"]),whatsappNumber:s.z.string().optional(),email:s.z.string().email().optional(),whatsappOtp:s.z.string().optional(),emailOtp:s.z.string().optional(),sessionToken:s.z.string().optional()});async function u(e){try{let r=await e.json(),t=d.parse(r),n=e.headers.get("x-forwarded-for")||"unknown",o=e.headers.get("user-agent")||"unknown";if("whatsapp"===t.step){if(t.whatsappNumber!==process.env.ADMIN_WHATSAPP_NUMBER)return i.Z.json({error:"N\xfamero no autorizado"},{status:403});let e=Object(function(){var e=Error("Cannot find module '@/lib/encryption'");throw e.code="MODULE_NOT_FOUND",e}()).generateToken(),r=new Date(Date.now()+432e5);await Object(function(){var e=Error("Cannot find module '@/lib/prisma'");throw e.code="MODULE_NOT_FOUND",e}()).adminSession.create({data:{token:e,ipAddress:n,userAgent:o,expiresAt:r}});let a=await Object(function(){var e=Error("Cannot find module '@/lib/otp-service'");throw e.code="MODULE_NOT_FOUND",e}()).sendWhatsAppOTP(t.whatsappNumber);if(!a)return i.Z.json({error:"Error al enviar c\xf3digo"},{status:500});return i.Z.json({sessionToken:e,message:"C\xf3digo enviado por WhatsApp"})}if("email"===t.step){let e=await Object(function(){var e=Error("Cannot find module '@/lib/prisma'");throw e.code="MODULE_NOT_FOUND",e}()).adminSession.findUnique({where:{token:t.sessionToken}});if(!e||!e.whatsappVerified)return i.Z.json({error:"Sesi\xf3n inv\xe1lida"},{status:401});if(t.email!==process.env.ADMIN_EMAIL_ADDRESS)return i.Z.json({error:"Email no autorizado"},{status:403});let r=await Object(function(){var e=Error("Cannot find module '@/lib/otp-service'");throw e.code="MODULE_NOT_FOUND",e}()).sendEmailOTP(t.email);if(!r)return i.Z.json({error:"Error al enviar c\xf3digo por email"},{status:500});return i.Z.json({message:"C\xf3digo enviado por email"})}if("verify"===t.step){let e=await Object(function(){var e=Error("Cannot find module '@/lib/prisma'");throw e.code="MODULE_NOT_FOUND",e}()).adminSession.findUnique({where:{token:t.sessionToken}});if(!e)return i.Z.json({error:"Sesi\xf3n inv\xe1lida"},{status:401});let r=!1,n=!1;if(t.whatsappOtp&&6===t.whatsappOtp.length&&(r=!0),t.emailOtp&&6===t.emailOtp.length&&(n=!0),!r||!n)return i.Z.json({error:"C\xf3digos de verificaci\xf3n inv\xe1lidos"},{status:401});return await Object(function(){var e=Error("Cannot find module '@/lib/prisma'");throw e.code="MODULE_NOT_FOUND",e}()).adminSession.update({where:{id:e.id},data:{whatsappVerified:!0,emailVerified:!0}}),i.Z.json({message:"Autenticaci\xf3n completa",sessionToken:e.token})}return i.Z.json({error:"Paso inv\xe1lido"},{status:400})}catch(e){return console.error("Admin auth error:",e),i.Z.json({error:"Error interno del servidor"},{status:500})}}let p=o.AppRouteRouteModule,l=new p({definition:{kind:a.x.APP_ROUTE,page:"/api/admin/auth/route",pathname:"/api/admin/auth",filename:"route",bundlePath:"app/api/admin/auth/route"},resolvedPagePath:"/home/project/frontend/app/api/admin/auth/route.ts",nextConfigOutput:"",userland:n}),{requestAsyncStorage:c,staticGenerationAsyncStorage:f,serverHooks:m,headerHooks:O,staticGenerationBailout:h}=l,w="/api/admin/auth/route"},84952:(e,r)=>{var t;Object.defineProperty(r,"x",{enumerable:!0,get:function(){return t}}),function(e){e.PAGES="PAGES",e.PAGES_API="PAGES_API",e.APP_PAGE="APP_PAGE",e.APP_ROUTE="APP_ROUTE"}(t||(t={}))}};var r=require("../../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),n=r.X(0,[670,704],()=>t(20082));module.exports=n})();